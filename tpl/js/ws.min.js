$(function(){function WebSocketAjaxClient(path,data,stop){conn&&1===conn.readyState?(WebSocketStatus('<b style="color:blue">send',path+(data?JSON.stringify(data):"")),conn.send(JSON.stringify({path:path,data:data}))):(conn=new WebSocket(url),conn.onopen=function(){path&&(conn.send(JSON.stringify({path:path,data:data})),WebSocketStatus('<b style="color:blue">send',path+(data?JSON.stringify(data):""))),console.info("Socket open"),WebSocketStatus('<b style="color:green">socket',"open")}),conn.onerror=function(e){WebSocketStatus('<b style="color:red">error',JSON.stringify(e)),console.error("There was an un-identified Web Socket error"),stop!==!0?WebSocketAjaxClient(path,data,!0):ws=1},conn.onmessage=function(e){WebSocketStatus('<b style="color:purple">receive',e.data),data=$.parseJSON(e.data),data.error?$("#report-popup").show().find(".txt").text(getText(data.error)).fadeIn(200):(path=data.path,data.res&&(data.res.appId&&data.res.appId!=onlineGame.appId?onlineGame={}:onlineGame.winner&&(onlineGame.winner=null,onlineGame.fields=null),$.each(data.res,function(e,a){onlineGame[e]=a}),data.res.appName&&(appName=data.res.appName),data.res.appMode&&(appMode=data.res.appMode),data.res.appId&&(appId=data.res.appId,data=null),playAudio([appName,onlineGame.action])),eval(path.replace("\\","")+"Callback")(data))}}function WebSocketStatus(e,a){$("#wsStatus").html(e+": </b>"+a+"</br>"+$("#wsStatus").html())}function stackCallback(){$(".ngm-bk .rls-r-t").is(":visible")?($(".ngm-bk .rls-r-ts").show(),$(".ngm-bk .rls-r-t").hide(),$(".ngm-bk .prc-but-cover").show()):($(".ngm-bk .ngm-gm .gm-mx .msg.winner .re").hide(),$(".ngm-bk .ngm-gm .gm-mx .msg.winner .ch-ot").hide(),$(".ot-exit").html("Ожидаем соперника").show())}function cancelCallback(){$(".ngm-bk .rls-r-ts").hide(),$(".ngm-bk .rls-r-t").show(),$(".ngm-bk .prc-but-cover").hide()}function quitCallback(){appId=0,WebSocketAjaxClient("update/"+appName),$(".ngm-bk .tm").countdown("pause"),$(".ngm-bk .ngm-gm .gm-mx .msg.winner .button.exit").hasClass("button-disabled")?$(".ngm-bk .ngm-gm .gm-mx .msg.winner .button").removeClass("button-disabled").removeAttr("disabled"):$(".ngm-bk .ngm-gm .gm-mx .players .exit").is(":visible")&&$(".ngm-bk .ngm-gm .gm-mx .players .exit").removeClass("button-disabled"),$(".ngm-bk .rls-r-ts").hide(),$(".ngm-bk .rls-r-t").show(),$(".ngm-bk .prc-but-cover").hide(),$(".ngm-rls").fadeIn(200)}function backCallback(){$(".ngm-bk .rls-r-t").is(":visible")||cancelCallback(),$(".ngm-bk").fadeOut(200),window.setTimeout(function(){$(".ch-bk").fadeIn(200)},200)}function ratingCallback(e){$(".ngm-rls .rls-r .preloader").remove(),e.res.top&&(html="",e.res.top.POINT&&$.each(e.res.top.POINT,function(e,a){html+='<li><div class="prs-ph" style="background-image: url(',html+=a.A?"'../filestorage/avatars/"+Math.ceil(parseInt(a.I)/100)+"/"+a.A+"'":"'../tpl/img/default.jpg'",html+=')"></div><div class="prs-ifo"><div class="nm">'+a.N+(a.O?" <b>•</b>":"")+'</div><div class="ifo"><div class="icon-star"></div> '+Math.ceil(a.R)+"</div></div></li>"}),$(".rls-r .rls-r-prs.top-pnt").html(html),html="",e.res.top.MONEY&&$.each(e.res.top.MONEY,function(e,a){html+='<li><div class="prs-ph" style="background-image: url(',html+=a.A?"'../filestorage/avatars/"+Math.ceil(parseInt(a.I)/100)+"/"+a.A+"'":"'../tpl/img/default.jpg'",html+=')"></div><div class="prs-ifo"><div class="nm">'+a.N+(a.O?" <b>•</b>":"")+'</div><div class="ifo"><div class="icon-star"></div> '+Math.ceil(a.R)+"</div></div></li>"}),$(".rls-r .rls-r-prs.top-mon").html(html))}function updateCallback(e){e.res.points&&updatePoints(e.res.points),e.res.money&&updateMoney(e.res.money),e.res.modes&&(appModes[e.res.key]=e.res.modes),e.res.audio&&(appAudio[e.res.key?e.res.key:e.res.appName]=e.res.audio),e.res.key&&($(".ngm-bk .ngm-rls-bk .rls-r .rls-r-t .rls-r-t-rating .rls-r-t-rating-points").text(e.res.count>0?Math.ceil(parseInt(e.res.win)+parseInt(e.res.count)):"0"),$(".ngm-bk .ngm-rls-bk .rls-r .rls-mn-bk .bt").removeClass("button-disabled").removeAttr("disabled"),$(".ngm-bk .cell .bt").first().click()),e.res.fund&&($(".prz-fnd-mon").text(e.res.fund.MONEY?getCurrency(e.res.fund.MONEY,1):0),$(".prz-fnd-pnt").text(e.res.fund.POINT?parseInt(e.res.fund.POINT):0))}function nowCallback(e){$(".ngm-rls .rls-r .preloader").remove(),html="",e.res.now&&e.res.now.length?($(".ngm-rls .rls-r .now-bl ul").show(),$(".ngm-rls .rls-r .now-bl .gn-now-create").hide(),$.each(e.res.now,function(e,a){mode=a.mode.split("-"),number=mode[2]?mode[2]:2,html+='<div class="gm-now'+(a.players.length<number?" available":"")+'"><div class="gm-now-md"><b>'+("MONEY"==mode[0]?getCurrency(mode[1],1):mode[1])+"</b><i>"+("MONEY"==mode[0]?getCurrency():"баллов")+'</i></div><div class="gm-now-nmb"><span class="icon-users"></span> '+a.players.length+"/"+number+"</div>",players=[],$.each(a.players,function(e,a){players.push(a)}),html+='<div class="gm-now-plr">'+players.join(", ")+(a.players.length<number?'<span data-id="'+a.id+'" data-mode="'+a.mode+'" class="icon-control-play"></span>':"")+"</div></div>"})):($(".ngm-rls .rls-r .now-bl ul").hide(),$(".ngm-rls .rls-r .now-bl .gn-now-create").show()),$(".ngm-rls .rls-r .now-bl .list-games").replaceWith('<div class="list-games">'+html+"</div>"),""!=html&&($(".ngm-rls .rls-r .now-bl ul li.bt-all.sel").length||$(".ngm-rls .rls-r .now-bl .list-games div.gm-now:not(.available)").hide(),$(".ngm-rls .rls-r .now-bl ul li.bt-all span").text("("+$(".ngm-rls .rls-r .now-bl .list-games div.gm-now").length+")"),$(".ngm-rls .rls-r .now-bl ul li.bt-om span").text("("+$(".ngm-rls .rls-r .now-bl .list-games div.gm-now.available").length+")"))}function appchatCallback(e){$("#chatMessage").val("").focus(),user=e.res.user,user=e.res.uid?e.res.uid==playerId?'<b style="color:green;">'+user:'<b style="color:blue;">'+user:'<b style="color:red;">system',$("#chatStatus").html(user+": </b>"+e.res.message+"</br>"+$("#chatStatus").html())}function appSeaBattleCallback(){switch(onlineGame.action){case"reply":$(".re").hide(),$(".ot-exit").html("Ожидаем соперника").show();break;case"stack":break;case"wait":hideAllGames(),$("ul.mx.SeaBattle.m").find("div").length||$("ul.mx.SeaBattle.m").find("li.s").length||(runGame(),$(".ngm-bk .gm-fld .place").show(),$(".gm-pr .pr-cl").show().html("<span>корабли</span><b></b>"),$(".gm-pr.r .pr-cl").hide(),price=onlineGame.appMode.split("-"),$(".gm-pr .pr-pr").show().html("<b>"+("MONEY"==price[0]?getCurrency(price[1],1):price[1])+"</b><span>"+("MONEY"==price[0]?getCurrency():"баллов")+"<br>ставка</span>"),$.each(onlineGame.players,function(e,a){var n=a.pid,l=n==playerId?"l":"r";html="",$.each(a.ships,function(e,a){html+='<div class="s '+(a?"":"e ")+'" style="width:'+20*e+'px"><b>'+a+"</b></div>"}),$(".gm-pr."+l+" .pr-cl b").html(html);var m=n==playerId?"m":"o";$(".ngm-bk ul.mx."+m+" li").each(function(){$(this).attr("data-cell",$(this).data("coor")+"x"+n).addClass(n==playerId?"m":"")}),a.avatar=a.avatar?"url('../filestorage/avatars/"+Math.ceil(parseInt(a.pid)/100)+"/"+a.avatar+"')":"url('../tpl/img/default.jpg')",$(".gm-pr."+l+" .pr-ph-bk .pr-ph").css("background-image",a.avatar),n!=playerId&&a.name&&$(".gm-pr.r .pr-nm").html(a.name)}),appId=onlineGame.appId,updateTimeOut(onlineGame.timeout)),$(".sb-wait").show(),$(".sb-ready.but, .sb-random.but").hide(),$.each(onlineGame.fields,function(e,a){class_cell=e==playerId?"m":"o",$.each(a,function(a,n){$.each(n,function(n,l){$(".ngm-bk .ngm-gm .gm-mx ul.mx.SeaBattle."+class_cell+" li.last").removeClass("last"),$(".ngm-bk .ngm-gm .gm-mx ul.mx.SeaBattle."+class_cell+' li[data-cell="'+a+"x"+n+"x"+e+'"]').addClass((is_numeric(l)?"s":l)+" last").fadeIn(100)})})});break;case"field":hideAllGames(),(!$("ul.mx.SeaBattle.m").find("div").length&&!$("ul.mx.SeaBattle.m").find("li.s").length||$("ul.SeaBattle.o").is(":visible"))&&(runGame(),window.game_ships=onlineGame.ships,genFieldSeaBattle(),$(".ngm-bk .gm-fld .place").show(),$(".ngm-bk .gm-fld .mx.SeaBattle.o").hide(),$(".sb-wait").hide(),$(".sb-ready.but, .sb-random.but").show()),$(".gm-pr .pr-cl").show().html("<span>корабли</span><b></b>"),$(".gm-pr.r .pr-cl").hide(),updateTimeOut(onlineGame.timeout),price=onlineGame.appMode.split("-"),$(".gm-pr .pr-pr").show().html("<b>"+("MONEY"==price[0]?getCurrency(price[1],1):price[1])+"</b><span>"+("MONEY"==price[0]?getCurrency():"баллов")+"<br>ставка</span>"),$.each(onlineGame.players,function(e,a){var n=a.pid,l=n==playerId?"l":"r";html="",$.each(a.ships,function(e,a){html+='<div class="s '+(a?"":"e ")+'" style="width:'+20*e+'px"><b>'+a+"</b></div>"}),$(".gm-pr."+l+" .pr-cl b").html(html);var m=n==playerId?"m":"o";$(".ngm-bk ul.mx."+m+" li").each(function(){$(this).attr("data-cell",$(this).data("coor")+"x"+n).addClass(n==playerId?"m":"")}),a.avatar=a.avatar?"url('../filestorage/avatars/"+Math.ceil(parseInt(a.pid)/100)+"/"+a.avatar+"')":"url('../tpl/img/default.jpg')",$(".gm-pr."+l+" .pr-ph-bk .pr-ph").css("background-image",a.avatar),n!=playerId&&a.name&&$(".gm-pr.r .pr-nm").html(a.name)}),$(".ngm-bk .ngm-gm .tm").css("text-align","center"),$(".gm-pr.l").addClass("move"),$(".gm-pr.r").removeClass("move"),$("ul.mx.SeaBattle.m").css("opacity",1);break;case"start":onlineGame.winner||updateTimeOut(onlineGame.timeout),hideAllGames(),runGame(),$(".ngm-bk .gm-fld .place").hide(),$(".ngm-bk .gm-fld .mx.SeaBattle.o").show(),$(".gm-pr .pr-cl").show().css("opacity",1).html("<span>корабли</span><b></b>"),$("ul.mx.SeaBattle.m div").remove(),price=onlineGame.appMode.split("-"),$(".gm-pr .pr-pr").show().html("<b>"+("MONEY"==price[0]?getCurrency(price[1],1):price[1])+"</b><span>"+("MONEY"==price[0]?getCurrency():"баллов")+"<br>ставка</span>"),$.each(onlineGame.players,function(e,a){var n=a.pid,l=n==playerId?"l":"r",m=n==playerId?"m":"o";html="",$.each(a.ships,function(e,a){html+='<div class="s '+(a?"":"e ")+m+'" style="width:'+20*e+'px"><b>'+a+"</b></div>"}),$(".gm-pr."+l+" .pr-cl b").html(html),$(".ngm-bk ul.mx."+m+" li").each(function(){$(this).attr("data-cell",$(this).data("coor")+"x"+n).addClass(n==playerId?"m":"")}),a.avatar=a.avatar?"url('../filestorage/avatars/"+Math.ceil(parseInt(n)/100)+"/"+a.avatar+"')":"url('../tpl/img/default.jpg')",$(".gm-pr."+l+" .pr-ph-bk .pr-ph").css("background-image",a.avatar),n!=playerId&&a.name&&$(".gm-pr.r .pr-nm").html(a.name)}),onlineGame.current!=playerId?($("ul.mx.SeaBattle.o").css("opacity",.5),$("ul.mx.SeaBattle.m").css("opacity",1),$(".ngm-bk .ngm-gm .tm").css("text-align","right"),$(".gm-pr.r").addClass("move"),$(".gm-pr.l").removeClass("move")):($("ul.mx.SeaBattle.o").css("opacity",1),$("ul.mx.SeaBattle.m").css("opacity",.5),$(".ngm-bk .ngm-gm .tm").css("text-align","left"),$(".gm-pr.l").addClass("move"),$(".gm-pr.r").removeClass("move")),$.each(onlineGame.fields,function(e,a){class_cell=e==playerId?"m":"o",$.each(a,function(a,n){$.each(n,function(n,l){$(".ngm-bk .ngm-gm .gm-mx ul.mx.SeaBattle."+class_cell+" li.last").removeClass("last"),$(".ngm-bk .ngm-gm .gm-mx ul.mx.SeaBattle."+class_cell+' li[data-cell="'+a+"x"+n+"x"+e+'"]').addClass((is_numeric(l)?"s":l)+" last").addClass(class_cell).fadeIn(100)})})}),onlineGame.winner&&endGame();break;case"move":if(onlineGame.cell&&(class_cell=onlineGame.cell.coord.split("x")[2]==playerId?"m":"o",(move="e"==onlineGame.cell.class?1:"d"==onlineGame.cell.class?2:"k"==onlineGame.cell.class?3:null)&&playAudio([appName,"Move-"+class_cell+"-"+move]),$(".ngm-bk .ngm-gm .gm-mx ul.mx li."+class_cell+".last").removeClass("last"),$('.ngm-bk .ngm-gm .gm-mx ul.mx li[data-cell="'+onlineGame.cell.coord+'"]').addClass(onlineGame.cell.class).html('<div class="'+onlineGame.cell.class+'" style="background:'+$('.ngm-bk .ngm-gm .gm-mx ul.mx li[data-cell="'+onlineGame.cell.coord+'"]').css("background")+';width:19px;height:19px;"></div>').find("div").effect("explode",{pieces:4},500).parent().addClass(class_cell+" last").fadeIn(300).html("d"==onlineGame.cell.class?"<img src='tpl/img/games/damage.png'>":"")),onlineGame.fields&&$.each(onlineGame.fields,function(e,a){class_cell=e==playerId?"m":"o",$.each(a,function(a,n){$.each(n,function(n,l){$(".ngm-bk .ngm-gm .gm-mx ul.mx.SeaBattle."+class_cell+" li.last").removeClass("last"),$(".ngm-bk .ngm-gm .gm-mx ul.mx.SeaBattle."+class_cell+' li[data-cell="'+a+"x"+n+"x"+e+'"]').addClass((is_numeric(l)?"s":l)+" last").addClass(class_cell).fadeIn(100).html("d"==l?"<img src='tpl/img/games/damage.png'>":"")})})}),onlineGame.extra){var e=$(".ngm-bk .msg.equal");e.fadeIn(200),window.setTimeout(function(){e.fadeOut(200)},2e3)}onlineGame.current&&(onlineGame.current!=playerId?($("ul.mx.SeaBattle.o").css("opacity",.5),$("ul.mx.SeaBattle.m").css("opacity",1),$(".ngm-bk .ngm-gm .tm").css("text-align","right"),$(".gm-pr.r").addClass("move"),$(".gm-pr.l").removeClass("move")):($("ul.mx.SeaBattle.o").css("opacity",1),$("ul.mx.SeaBattle.m").css("opacity",.5),$(".ngm-bk .ngm-gm .tm").css("text-align","left"),$(".gm-pr.l").addClass("move"),$(".gm-pr.r").removeClass("move"))),onlineGame.players&&$.each(onlineGame.players,function(e,a){var n=a.pid==playerId?"l":"r",l=a.pid==playerId?"m":"o";html="",$.each(a.ships,function(e,a){html+='<div class="s '+(a?"":"e ")+l+'" style="width:'+20*e+'px"><b>'+a+"</b></div>"}),$(".gm-pr."+n+" .pr-cl b").html(html),$(".gm-pr."+n+" .pr-cl b").html(html),$(".gm-pr."+n+" .pr-pt b").html(a.points).hide().fadeIn(200)}),onlineGame.winner||updateTimeOut(onlineGame.timeout),onlineGame.winner&&($(".ngm-bk .tm").countdown("pause"),$(".ngm-bk .msg").hide(),$(".gm-pr").removeClass("move"),$(".ngm-bk .ngm-gm .gm-pr .pr-surr").hide(),$(".ngm-bk .ngm-gm .gm-mx ul.mx.SeaBattle.o li.s:not(.d,.k)").effect("pulsate",{times:10}),class_player=onlineGame.winner==playerId?"l":"r",win=onlineGame.players[onlineGame.winner].win,setTimeout(function(){$(".msg.winner").fadeIn(200),$(".gm-pr .pr-cl, .gm-pr .pr-pr").hide(),$(".gm-pr."+class_player+" .pr-cl").show().html("<b>"+("MONEY"==onlineGame.currency?getCurrency(win,1):win)+"</b><span>"+("MONEY"==onlineGame.currency?getCurrency():"баллов")+"<br>выиграно</span>"),$(".gm-pr."+class_player).addClass("winner")},onlineGame.winner==playerId?1200:3600),$(".ngm-bk .ngm-gm .gm-mx .msg.winner .ch-ot").show(),$(".ngm-bk .ngm-gm .gm-mx .msg.winner .re").show(),$(".ngm-bk .ot-exit").hide());break;case"quit":$(".ngm-bk .re").hide(),$(".ngm-bk .ot-exit").html("Соперник вышел").show(),appId=0;break;case"error":errorGame()}}function checkFieldSeaBattle(e,a){var n=$(".mx.SeaBattle:eq(1) li").last().attr("data-coor").split("x"),m=n[0],r=n[1];matrix=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,0],[0,1],[1,-1],[1,0],[1,1]];var t=window.game_ships,s=[];for(y=1;r>=y;y++)for(s[y]=[],x=1;m>=x;x++)s[y][x]=0;var i=0,o=0,p=!1;e:for(;i!=t.length&&(o++,!(o>100));){for(data=i!=a?window.ships[i]:e,x=data[0][0],y=data[0][1],h=data[1],l=data[2],ship=[];ship.length!=l;){if(x>m||y>r)return!1;if($.each(matrix,function(e,a){y+a[0]>0&&y+a[0]<=r&&x+a[1]>0&&x+a[1]<=m&&s[y+a[0]][x+a[1]]&&(p=!0)}),p)return!1;ship.push([x,y]),h?x++:y++}$.each(ship,function(e,a){s[a[1]][a[0]]=1}),i++}return!0}function genFieldSeaBattle(){window.ships=[];var e=$(".mx.SeaBattle:eq(1) li").last().attr("data-coor").split("x"),a=e[0],n=e[1];matrix=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,0],[0,1],[1,-1],[1,0],[1,1]];var m=window.game_ships,r=[];for(y=1;n>=y;y++)for(r[y]=[],x=1;a>=x;x++)r[y][x]=0;var t=0,s=0;e:for(;window.ships.length!=m.length&&(s++,!(s>100));){for(x=Math.ceil(Math.random()*a),y=Math.ceil(Math.random()*n),h=Math.ceil(2*Math.random())-1,l=m[t],ship=[];ship.length!=l;){if(con=!1,1!=l&&(h&&x+1>a||!h&&y+1>n))continue e;if($.each(matrix,function(e,l){y+l[0]>0&&y+l[0]<=n&&x+l[1]>0&&x+l[1]<=a&&r[y+l[0]][x+l[1]]&&(con=!0)}),con)continue e;ship.push([x,y]),h?x++:y++}$.each(ship,function(e,a){r[a[1]][a[0]]=1}),window.ships.push([ship[0],h,l]),t++}var i=parseFloat($(".mx.SeaBattle:eq(1) li").last().css("width")),o=parseFloat($(".mx.SeaBattle:eq(1) li").last().css("height")),p="";$.each(window.ships,function(e,a){p+='<div data-id="'+e+'" style="top:'+(a[0][1]*(o+1)-(o+1))+"px;left:"+(a[0][0]*(i+1)-(i+1))+"px;"+(a[1]?"width: "+a[2]*(i+1)+"px;height:"+(o+1)+"px;":"height: "+a[2]*(o+1)+"px;width:"+(i+1)+"px;")+'" class="s '+(a[1]?"h":"")+' drag"></div>'}),$("ul.mx.SeaBattle.m div").remove(),$("ul.SeaBattle.m").append(p),$(".drag").dblclick(function(){var e=$(this),a=e.css("width"),n=e.css("height"),l=e.hasClass("h")?0:1,m=[].concat(window.ships[e.data("id")]);m[1]=l,checkFieldSeaBattle(m,$(this).data("id"))?($(this).css("width",n).css("height",a).removeClass("h").addClass(l?"h":""),window.ships[$(this).data("id")][1]=l):($(this).removeClass("drag ui-draggable ui-draggable-handle"),$(this).effect("shake",{distance:5,times:1,duration:2}),window.setTimeout(function(){e.addClass("drag ui-draggable ui-draggable-handle")},1e3))}),$(".drag").draggable({containment:"parent",grid:[i+1,o+1],revert:function(){var e=[].concat(window.ships[$(this).data("id")]);return e[0]=[(parseInt($(this).css("left"))+(i+1))/(i+1),(parseInt($(this).css("top"))+(o+1))/(o+1)],checkFieldSeaBattle(e,$(this).data("id"))?(window.ships[$(this).data("id")][0]=[(parseInt($(this).css("left"))+(i+1))/(i+1),(parseInt($(this).css("top"))+(o+1))/(o+1)],!1):!0},start:function(){},stop:function(){}})}function printField(e){$("ul.SeaBattle.m li").html(""),$.each(e,function(e,a){a&&$.each(a,function(a,n){n&&$("ul.SeaBattle.m").find('li[data-coor="'+a+"x"+e+'"]').html(n)})})}function appFiveLineCallback(){switch(onlineGame.action){case"reply":$(".re").hide(),$(".ot-exit").html("Ожидаем соперника").show();break;case"stack":break;case"start":hideAllGames(),runGame(),$(".gm-pr .pr-cl").css("opacity","100").hide().html("<b>0</b><span>ходов<br>осталось</span>"),$(".gm-pr .pr-pt").css("opacity","100").hide().html("<b>0</b><span>очков<br>набрано</span>"),onlineGame.winner||updateTimeOut(onlineGame.timeout),$(".ngm-rls").fadeOut(200),$(".ngm-bk .ngm-gm .gm-mx ul.mx > li").html("").removeClass(),price=onlineGame.appMode.split("-"),$(".gm-pr .pr-pr").show().html("<b>"+("MONEY"==price[0]?getCurrency(price[1],1):price[1])+"</b><span>"+("MONEY"==price[0]?getCurrency():"баллов")+"<br>ставка</span>"),$.each(onlineGame.players,function(e,a){var n=a.pid==playerId?"l":"r";$(".gm-pr."+n+" .pr-cl b").html(a.moves),$(".gm-pr."+n+" .pr-pt b").html(a.points),a.avatar=a.avatar?"url('../filestorage/avatars/"+Math.ceil(parseInt(a.pid)/100)+"/"+a.avatar+"')":"url('../tpl/img/default.jpg')",$(".gm-pr."+n+" .pr-ph-bk .pr-ph").css("background-image",a.avatar),a.pid!=playerId&&a.name&&$(".gm-pr.r .pr-nm").html(a.name)}),onlineGame.current!=playerId?($(".ngm-bk .ngm-gm .tm").css("text-align","right"),$(".gm-pr.r").addClass("move"),$(".gm-pr.l").removeClass("move")):($(".ngm-bk .ngm-gm .tm").css("text-align","left"),$(".gm-pr.l").addClass("move"),$(".gm-pr.r").removeClass("move")),$.each(onlineGame.field,function(e,a){$.each(a,function(e,a){if(a.player==playerId)var n="m";else var n="o";$(".ngm-bk .ngm-gm .gm-mx ul.mx li."+n+".last").removeClass("last"),$('.ngm-bk .ngm-gm .gm-mx ul.mx li[data-cell="'+a.coord+'"]').html("<div></div>").addClass((is_numeric(n)?"s":n)+" last").fadeIn(100)})}),onlineGame.winner&&endGame();break;case"move":if(onlineGame.cell){if(onlineGame.cell.player==playerId)var e="m";else var e="o";playAudio([appName,"Move-"+e+"-1"]),$(".ngm-bk .ngm-gm .gm-mx ul.mx li."+e+".last").removeClass("last"),cell=$('.ngm-bk .ngm-gm .gm-mx ul.mx li[data-cell="'+onlineGame.cell.coord+'"]'),cell.html('<div style="display:none;"></div>').find("div").fadeIn(200),cell.addClass(e+" last").fadeIn(300)}if(onlineGame.extra){var a=$(".ngm-bk .msg.equal");window.setTimeout(function(){a.fadeIn(200)},500),window.setTimeout(function(){a.fadeOut(200)},2500)}onlineGame.current&&(onlineGame.current!=playerId?($(".ngm-bk .ngm-gm .tm").css("text-align","right"),$(".gm-pr.r").addClass("move"),$(".gm-pr.l").removeClass("move")):($(".ngm-bk .ngm-gm .tm").css("text-align","left"),$(".gm-pr.l").addClass("move"),$(".gm-pr.r").removeClass("move"))),onlineGame.players&&$.each(onlineGame.players,function(e,a){var n=a.pid==playerId?"l":"r";$(".gm-pr."+n+" .pr-cl b").html(a.moves).hide().fadeIn(200),$(".gm-pr."+n+" .pr-pt b").html(a.points).hide().fadeIn(200)}),onlineGame.line&&$.each(onlineGame.line,function(e,a){$.each(a,function(a){$('.ngm-bk .ngm-gm .gm-mx ul.mx li[data-cell="'+e+"x"+a+'"]').addClass("w").addClass("last")})}),onlineGame.winner&&endGame()||updateTimeOut(onlineGame.timeout);break;case"quit":onlineGame.quit!=playerId&&($(".ngm-bk .re").hide(),$(".ngm-bk .ot-exit").html("Соперник вышел").show()),appId=0;break;case"error":errorGame()}}function appDurakRevertCallback(e){appDurakCallback(e)}function appDurakCallback(e){switch(e=e&&e.res&&e.res.action?e.res.action:e||onlineGame.action){case"reply":$(".re").hide(),$(".ot-exit").html("Ожидаем соперника").show();break;case"stack":break;case"start":case"timeout":case"pass":case"move":case"wait":case"ready":if($(".ui-droppable").droppable("destroy"),$(".m .card.draggable").draggable("destroy"),echo(onlineGame.action),echo(onlineGame),-1==$.inArray(onlineGame.action,["move","timeout","pass"])&&("ready"!=onlineGame.action||Object.size(onlineGame.players)==onlineGame.current.length)||!$(".ngm-bk .ngm-gm .gm-mx .mx .players").children("div").length){if(hideAllGames(),runGame(),$(".ngm-bk .ngm-gm").addClass("cards"),$(".ngm-rls").fadeOut(200),echo("обнулили поля"),fields=[],statuses=[],timestamp=null,players=onlineGame.players){if("wait"==onlineGame.action){var a={avatar:"",name:"ждем..."};for(i=Object.size(players);i<onlineGame.playerNumbers;i++)index=0-i,players[index]=a}if("start"==onlineGame.action){var n=Object.keys(players),l=players[playerId].order;n.sort(function(e,a){return e=players[e].order,a=players[a].order,check=e==l?1:a==l?-1:l>e&&l>a||e>l&&a>l?e-a:a-e}),$.each(n,function(e,a){div='<div class="player'+a+(a==playerId?" m":" o col"+(Object.size(players)-1))+'"></div>',$(".ngm-bk .ngm-gm .gm-mx .mx .players").append(div)})}$.each(players,function(e,a){"start"!=onlineGame.action&&(div='<div class="player'+e+(e==playerId?" m":" o col"+(Object.size(players)-1))+'"></div>',$(".ngm-bk .ngm-gm .gm-mx .mx .players").append(div)),a.avatar=0>e?"url(../tpl/img/preloader.gif)":a.avatar?"url('../filestorage/avatars/"+Math.ceil(parseInt(a.pid)/100)+"/"+a.avatar+"')":"url('../tpl/img/default.jpg')",$(".ngm-bk .ngm-gm .gm-mx .mx .players .player"+e).append('<div class="gm-pr"><div class="pr-ph-bk"><div class="pr-ph" style="background-image: '+a.avatar+'"><div class="mt"></div><div class="wt"></div><div class="pr-nm">'+a.name+"</div></div></div></div>"),e==playerId&&(bet=price=onlineGame.appMode.split("-"),$(".ngm-bk .ngm-gm .gm-mx .mx .players .player"+e+" .gm-pr").prepend('<div class="pr-cl"><div class="btn-pass">пас</div><div class="msg-move">ваш ход</div></div>').append('<div class="pr-md"><i class="icon-reload"></i></div><div class="pr-pr"><b>'+("MONEY"==bet[0]?getCurrency(bet[1],1):bet[1])+"</b><span>"+("MONEY"==bet[0]?getCurrency(bet[1],2):"баллов")+'</span></div><div class="pr-pt"><div class="icon-wallet wallet"></div><div><span class="plMoneyHolder">'+playerMoney+"</span> "+getCurrency()+'</div><div><span class="plPointHolder">'+playerPoints+"</span> баллов</div></div>"))}),"ready"==onlineGame.action&&$(".ngm-bk .ngm-gm .gm-mx .mx .players .player"+playerId+" .gm-pr .btn-pass").addClass("btn-ready").removeClass("btn-pass").text("готов"),("ready"==onlineGame.action||"wait"==onlineGame.action)&&$(".ngm-bk .ngm-gm .gm-mx .mx .players").append('<div class="exit"><span class="icon-arrow-left"></span></div>')}onlineGame.trump&&$(".ngm-bk .ngm-gm .gm-mx .mx .deck").append('<div class="lear card'+onlineGame.trump[0]+'"></div><div class="last"></div>'+(onlineGame.fields.deck&&onlineGame.fields.deck.length?'<div class="card trump card'+onlineGame.trump+'"></div>':"")+(onlineGame.fields.deck&&onlineGame.fields.deck.length>1?'<div class="card"></div>':""))}var m=null;(-1==$.inArray(onlineGame.action,["ready","wait"])||onlineGame.fields)&&($.each(onlineGame.fields,function(e,a){if(a){if(newLen=a.length?a.length:Object.size(a),oldLen=fields&&fields[e]?fields[e].length?fields[e].length:Object.size(fields[e]):0,"deck"==e)return a.length?(1==a.length&&$(".ngm-bk .ngm-gm .gm-mx .mx .deck .card:not(.trump )").remove(),$(".ngm-bk .ngm-gm .gm-mx .mx .deck .last").text(a.length)):$(".ngm-bk .ngm-gm .gm-mx .mx .deck .lear").nextAll().hide(),!0;if("off"==e&&newLen==oldLen);else if(is_numeric(e)&&newLen==oldLen&&fields&&fields.deck&&fields.deck.length==onlineGame.fields.deck.length);else{is_numeric(e)?($(".ngm-bk .ngm-gm .gm-mx .mx .players .player"+e+" .card").remove(),m||(m=oldLen>newLen?e==playerId?"Move-m-1":"Move-m-2":"Move-o-2")):"off"!=e||0==newLen?$(".ngm-bk .ngm-gm .gm-mx .mx ."+e).html(""):"off"==e&&(m="Move-o-3");var n=0;$.each(a,function(l,m){if(n++,is_numeric(e)){cardsCount=a.length?a.length:Object.size(a);var r=cardsCount>1?n*((e==playerId?60:105)-(cardsCount>4?0:15*(4-cardsCount)))/cardsCount-(e==playerId?30:45):0;$(".ngm-bk .ngm-gm .gm-mx .mx .players .player"+e).append('<div style="transform: rotate('+r+"deg) "+(e==playerId?"":"scale(0.7, 0.7)")+"; -webkit-transform: rotate("+r+"deg)"+(e==playerId?"":"scale(0.7, 0.7)")+";"+(e==playerId?(1==n?"margin-left:"+(230+(cardsCount>4?cardsCount>8?-160:"":30*(6-cardsCount)))+"px;":"")+(cardsCount>6?"margin-right:-"+(110-(cardsCount>8?750:400)/cardsCount)+"px":""):"")+'"class="card '+(m?" card"+m+'" data-card="'+m:"")+'"></div>')}else if("table"==e){var t="";$.each(m,function(e,a){t+='<div class="card'+(a?" card"+a:"")+'"></div>'}),$(".ngm-bk .ngm-gm .gm-mx .mx ."+e).append('<div data-table="'+l+'" class="cards">'+t+"</div>")}else if("off"==e&&l>=$(".ngm-bk .ngm-gm .gm-mx .mx ."+e+" .card").length){var r=360*Math.random();$(".ngm-bk .ngm-gm .gm-mx .mx ."+e).append("<div "+("off"==e?'style="margin-top:'+160*Math.random()+"px;transform: scale(0.7,0.7) rotate("+r+"deg);-webkit-transform: scale(0.7,0.7) rotate("+r+'deg)" ':"")+'class="card'+(m?" card"+m:"")+'"></div>')}})}}}),appDurakCallback("premove")),fields=onlineGame.fields,$(".ngm-bk .ngm-gm .gm-mx .mx .players .mt").hide(),$(".ngm-bk .ngm-gm .gm-mx .mx .players > div").removeClass("current beater starter"),$.each(onlineGame.players,function(e,a){if(e==playerId&&"ready"!=onlineGame.action){var n="";e==onlineGame.beater?n="Беру":(-1!=$.inArray(parseInt(onlineGame.beater),onlineGame.current)||onlineGame.starter==playerId||onlineGame.beater&&onlineGame.players[onlineGame.beater].status&&2==onlineGame.players[onlineGame.beater].status)&&1!=onlineGame.players[playerId].status||onlineGame.beater&&onlineGame.players[onlineGame.beater].status?n="Пас":(-1==$.inArray(parseInt(onlineGame.beater),onlineGame.current)||1==onlineGame.players[playerId].status)&&(n="Отбой"),$(".ngm-bk .ngm-gm .gm-mx .mx .players .player"+playerId+" .gm-pr .btn-pass").text(n)}if(e==onlineGame.beater?$(".ngm-bk .ngm-gm .gm-mx .mx .players .player"+e).addClass("beater"):e!=onlineGame.starter||$(".ngm-bk .ngm-gm .gm-mx .mx .table .cards").length||$(".ngm-bk .ngm-gm .gm-mx .mx .players .player"+e).addClass("starter"),m||statuses[e]&&statuses[e]==a.status||!a.status||(m=e==onlineGame.beater?"Move-o-1":"Move-m-3"),statuses[e]=a.status?a.status:null,-1!=$.inArray(parseInt(e),onlineGame.current))$(".ngm-bk .ngm-gm .gm-mx .mx .players .player"+e).addClass("current"),-1==$.inArray(parseInt(onlineGame.beater),onlineGame.current)||-1!=$.inArray(parseInt(onlineGame.beater),onlineGame.current)&&onlineGame.beater==e?(onlineGame.timestamp&&timestamp!=onlineGame.timestamp||!$(".ngm-bk .ngm-gm .gm-mx .mx .players .player"+e+" .gm-pr .pr-ph-bk .circle-timer").length)&&(echo("remove"),$(".ngm-bk .ngm-gm .gm-mx .mx .players .player"+e+" .gm-pr .pr-ph-bk .circle, .ngm-bk .ngm-gm .gm-mx .mx .players .player"+e+" .gm-pr .pr-ph-bk .circle-timer").remove(),$(".ngm-bk .ngm-gm .gm-mx .mx .players .player"+e+" .gm-pr .pr-ph-bk").prepend('<div class="circle-timer"><div class="timer-r"></div><div class="timer-slot"><div class="timer-l"></div></div></div>').find(".timer-r,.timer-l").css("animation-duration",onlineGame.timeout+"s")):($(".ngm-bk .ngm-gm .gm-mx .mx .players .player"+e+" .gm-pr .pr-ph-bk .circle, .ngm-bk .ngm-gm .gm-mx .mx .players .player"+e+" .gm-pr .pr-ph-bk .circle-timer").remove(),$(".ngm-bk .ngm-gm .gm-mx .mx .players .player"+e+" .gm-pr .pr-ph-bk").prepend('<div class="circle"></div>'));else if($(".ngm-bk .ngm-gm .gm-mx .mx .players .player"+e+" .gm-pr .pr-ph-bk .circle, .ngm-bk .ngm-gm .gm-mx .mx .players .player"+e+" .gm-pr .pr-ph-bk .circle-timer").remove(),e==onlineGame.beater&&$(".ngm-bk .ngm-gm .gm-mx .mx .players .player"+e+" .gm-pr .pr-ph-bk").prepend('<div class="circle"></div>'),a.status||a.ready||onlineGame.winner){var n="";2==a.status&&onlineGame.beater==e?n="Беру":1==a.status&&onlineGame.starter==e?n="Пас":2==a.status?n="Отбой":1==a.ready&&(n="Готов"),$(".ngm-bk .ngm-gm .gm-mx .mx .players .player"+e+" .mt").show().text(n)}echo(timestamp),onlineGame.timestamp&&(timestamp=onlineGame.timestamp)}),updateTimeOut(onlineGame.timeout),onlineGame.winner?$(".ngm-bk .ngm-gm .gm-mx .mx .players .wt").is(":visible")||(playAudio([appName,-1!=$.inArray(playerId,onlineGame.winner)?"Win":"Lose"]),$.each(onlineGame.players,function(e,a){$(".ngm-bk .ngm-gm .gm-mx .mx .players .player"+e+" .wt").removeClass("loser").html((a.result>0?"Выигрыш":"Проигрыш")+"<br>"+("MONEY"==onlineGame.currency?getCurrency(a.win,1):parseInt(a.win))+" "+("MONEY"==onlineGame.currency?getCurrency():"баллов")).addClass(a.result<0?"loser":"").fadeIn(),e==playerId&&("MONEY"==onlineGame.currency?updateMoney(playerMoney+getCurrency(a.win,1)):updatePoints(playerPoints+parseInt(a.win)))}),setTimeout(function(){$(".ngm-bk .ngm-gm .gm-mx .players .exit").is(":visible")&&($(".ngm-bk .ngm-gm .gm-mx .mx .card, .ngm-bk .ngm-gm .gm-mx .mx .deck").fadeOut(),$(".ngm-bk .ngm-gm .gm-mx .mx .players .wt").fadeOut())},5e3)):m&&playAudio([appName,m]);break;case"highlight":onlineGame.beater==playerId&&$(".ngm-gm .gm-mx .table .cards").length&&($(".ngm-gm").hasClass("DurakRevert")&&$(".ngm-gm .gm-mx .table .cards").length==$(".ngm-gm .gm-mx .table .cards .card").length&&!$(".ngm-gm .gm-mx .table .revert").length&&$(".ngm-gm .gm-mx .table").append('<div data-table="revert" class="cards revert"><div class="card"></div></div>'),$(".ngm-gm .gm-mx .players .m .card.select").length?$(".ngm-gm .gm-mx .table .cards").each(function(){1!=$(".card",this).length||$(this).hasClass("highlight")||$(this).addClass("highlight")}):$(".highlight").removeClass("highlight"));break;case"premove":appDurakCallback("highlight"),$(".table"+(playerId==onlineGame.beater?" .cards:not(:has(.card:eq(1)))":"")).droppable({accept:".card",activeClass:"active",hoverClass:"hover",drop:function(e,a){$(this).attr("data-table")?$(this).click():$(a.draggable).click()}}),$(".m .card").draggable({zIndex:10,containment:"window",revert:function(e){return!e},start:function(){$(".m .card").removeClass("select"),$(this).addClass("select"),appDurakCallback("highlight")},stop:function(){}});break;case"quit":onlineGame.quit!=playerId?($(".ngm-bk .re").hide(),$(".ngm-bk .ot-exit").html("Соперник вышел").show()):appId=0;break;case"error":$(".m .card").removeClass("select").css("left",0).css("top",0),appDurakCallback("premove"),errorGame()}}function appWhoMoreCallback(){switch(onlineGame.action){case"reply":$(".re").hide(),$(".ot-exit").html("Ожидаем соперника").show();break;case"stack":break;case"start":hideAllGames(),runGame(),$(".gm-pr .pr-cl").css("opacity","100").show().html("<b>0</b><span>ходов<br>осталось</span>"),$(".gm-pr .pr-pt").css("opacity","100").show().html("<b>0</b><span>очков<br>набрано</span>"),onlineGame.winner||updateTimeOut(onlineGame.timeout),$(".ngm-rls").fadeOut(200),$(".ngm-bk .ngm-gm .gm-mx ul.mx > li").html("").removeClass(),price=onlineGame.appMode.split("-"),$(".gm-pr .pr-pr").show().html("<b>"+("MONEY"==price[0]?getCurrency(price[1],1):price[1])+"</b><span>"+("MONEY"==price[0]?getCurrency():"баллов")+"<br>ставка</span>"),$.each(onlineGame.players,function(e,a){var n=a.pid==playerId?"l":"r";$(".gm-pr."+n+" .pr-cl b").html(a.moves),$(".gm-pr."+n+" .pr-pt b").html(a.points),a.avatar=a.avatar?"url('../filestorage/avatars/"+Math.ceil(parseInt(a.pid)/100)+"/"+a.avatar+"')":"url('../tpl/img/default.jpg')",$(".gm-pr."+n+" .pr-ph-bk .pr-ph").css("background-image",a.avatar),a.pid!=playerId&&a.name&&$(".gm-pr.r .pr-nm").html(a.name)
}),onlineGame.current!=playerId?($(".ngm-bk .ngm-gm .tm").css("text-align","right"),$(".gm-pr.r").addClass("move"),$(".gm-pr.l").removeClass("move")):($(".ngm-bk .ngm-gm .tm").css("text-align","left"),$(".gm-pr.l").addClass("move"),$(".gm-pr.r").removeClass("move")),$.each(onlineGame.field,function(e,a){$.each(a,function(e,a){if(a.player==playerId)var n="m";else var n="o";$(".ngm-bk .ngm-gm .gm-mx ul.mx li."+n+".last").removeClass("last"),$('.ngm-bk .ngm-gm .gm-mx ul.mx li[data-cell="'+a.coord+'"]').html(a.points).addClass((is_numeric(n)?"s":n)+" last").fadeIn(100)})}),onlineGame.winner&&($(".ngm-bk .tm").countdown("pause"),$(".ngm-bk .msg").hide(),$(".gm-pr").removeClass("move"),$(".ngm-bk .ngm-gm .gm-pr .pr-surr").hide(),class_player=onlineGame.winner==playerId?"l":"r",win=onlineGame.players[onlineGame.winner].win,setTimeout(function(){$(".msg.winner").fadeIn(200),$(".gm-pr .pr-cl").css("opacity",0),$(".gm-pr .pr-pr").hide(),$(".gm-pr."+class_player+" .pr-cl").css("opacity","100").html("<b>"+("MONEY"==onlineGame.currency?getCurrency(win,1):win)+"</b><span>"+("MONEY"==onlineGame.currency?getCurrency():"баллов")+"<br>выиграно</span>"),$(".gm-pr."+class_player).addClass("winner")},1200),$(".ngm-bk .ngm-gm .gm-mx .msg.winner .ch-ot").show(),$(".ngm-bk .ngm-gm .gm-mx .msg.winner .re").show(),$(".ngm-bk .ot-exit").hide());break;case"move":if(onlineGame.cell){if(onlineGame.cell.player==playerId)var e="m";else var e="o";playAudio([appName,"Move-"+e+"-1"]),$(".ngm-bk .ngm-gm .gm-mx ul.mx li."+e+".last").removeClass("last"),cell=$('.ngm-bk .ngm-gm .gm-mx ul.mx li[data-cell="'+onlineGame.cell.coord+'"]'),cell.html('<div style="background:'+cell.css("background")+";width:"+cell.css("width")+";height:"+cell.css("height")+';"></div>').find("div").toggle("explode",{pieces:4},500).parent().html(onlineGame.cell.points).addClass(e+" last").fadeIn(300)}if(onlineGame.extra){var a=$(".ngm-bk .msg.equal");a.fadeIn(200),window.setTimeout(function(){a.fadeOut(200)},2e3)}onlineGame.current&&(onlineGame.current!=playerId?($(".ngm-bk .ngm-gm .tm").css("text-align","right"),$(".gm-pr.r").addClass("move"),$(".gm-pr.l").removeClass("move")):($(".ngm-bk .ngm-gm .tm").css("text-align","left"),$(".gm-pr.l").addClass("move"),$(".gm-pr.r").removeClass("move"))),onlineGame.players&&$.each(onlineGame.players,function(e,a){var n=a.pid==playerId?"l":"r";$(".gm-pr."+n+" .pr-cl b").html(a.moves).hide().fadeIn(200),$(".gm-pr."+n+" .pr-pt b").html(a.points).hide().fadeIn(200)}),onlineGame.winner||updateTimeOut(onlineGame.timeout),onlineGame.winner&&($(".ngm-bk .tm").countdown("pause"),$(".ngm-bk .msg").hide(),$(".gm-pr").removeClass("move"),$(".ngm-bk .ngm-gm .gm-pr .pr-surr").hide(),class_player=onlineGame.winner==playerId?"l":"r",win=onlineGame.players[onlineGame.winner].win,setTimeout(function(){$(".msg.winner").fadeIn(200),$(".gm-pr .pr-cl").css("opacity",0),$(".gm-pr .pr-pr").hide(),$(".gm-pr."+class_player+" .pr-cl").css("opacity","100").html("<b>"+("MONEY"==onlineGame.currency?getCurrency(win,1):win)+"</b><span>"+("MONEY"==onlineGame.currency?getCurrency():"баллов")+"<br>выиграно</span>"),$(".gm-pr."+class_player).addClass("winner")},1200),$(".ngm-bk .ngm-gm .gm-mx .msg.winner .ch-ot").show(),$(".ngm-bk .ngm-gm .gm-mx .msg.winner .re").show(),$(".ngm-bk .ot-exit").hide());break;case"quit":onlineGame.quit!=playerId&&($(".ngm-bk .re").hide(),$(".ngm-bk .ot-exit").html("Соперник вышел").show()),appId=0;break;case"error":errorGame()}}function appMinesCallback(){switch(onlineGame.action){case"reply":$(".re").hide(),$(".ot-exit").html("Ожидаем соперника").show();break;case"stack":break;case"start":hideAllGames(),runGame(),$(".gm-pr .pr-cl").css("opacity","100").show().html("<b>0</b><span>попыток<br>осталось</span>"),$(".gm-pr .pr-pt").css("opacity","100").show().html("<b>0</b><span>успешных<br>ходов</span>"),onlineGame.winner||updateTimeOut(onlineGame.timeout),$(".ngm-rls").fadeOut(200),$(".ngm-bk .ngm-gm .gm-mx ul.mx > li").html("").removeClass(),price=onlineGame.appMode.split("-"),$(".gm-pr .pr-pr").show().html("<b>"+("MONEY"==price[0]?getCurrency(price[1],1):price[1])+"</b><span>"+("MONEY"==price[0]?getCurrency():"баллов")+"<br>ставка</span>"),$.each(onlineGame.players,function(e,a){var n=a.pid==playerId?"l":"r";$(".gm-pr."+n+" .pr-cl b").html(a.moves),$(".gm-pr."+n+" .pr-pt b").html(a.points),a.avatar=a.avatar?"url('../filestorage/avatars/"+Math.ceil(parseInt(a.pid)/100)+"/"+a.avatar+"')":"url('../tpl/img/default.jpg')",$(".gm-pr."+n+" .pr-ph-bk .pr-ph").css("background-image",a.avatar),a.pid!=playerId&&a.name&&$(".gm-pr.r .pr-nm").html(a.name)}),onlineGame.current!=playerId?($(".ngm-bk .ngm-gm .tm").css("text-align","right"),$(".gm-pr.r").addClass("move"),$(".gm-pr.l").removeClass("move")):($(".ngm-bk .ngm-gm .tm").css("text-align","left"),$(".gm-pr.l").addClass("move"),$(".gm-pr.r").removeClass("move")),$.each(onlineGame.field,function(e,a){$.each(a,function(e,a){if(a.player==playerId)var n="m";else var n="o";$(".ngm-bk .ngm-gm .gm-mx ul.mx li."+n+".last").removeClass("last"),$('.ngm-bk .ngm-gm .gm-mx ul.mx li[data-cell="'+a.coord+'"]').html(a.points).addClass((is_numeric(n)?"s":n)+" last").fadeIn(100)})});break;case"move":if(onlineGame.cell){if(onlineGame.cell.player==playerId)var e="m";else if(onlineGame.cell.player)var e="o";playAudio([appName,"Move-"+e+"-1"]),$(".ngm-bk .ngm-gm .gm-mx ul.mx li."+e+".last").removeClass("last"),$('.ngm-bk .ngm-gm .gm-mx ul.mx li[data-cell="'+onlineGame.cell.coord+'"]').addClass(e+" last").html('<div style="background:'+$('.ngm-bk .ngm-gm .gm-mx ul.mx li[data-cell="'+onlineGame.cell.coord+'"]').css("background")+';width:100%;height:100%;">'+(is_numeric(onlineGame.cell.mine)?onlineGame.cell.mine:"m"==onlineGame.cell.mine?'<img src="tpl/img/games/bomb.png">':"")+"</div>").fadeIn(300)}if(onlineGame.field&&$.each(onlineGame.field,function(a,n){$.each(n,function(a,n){e=n.player==playerId?"m":"o",$('.ngm-bk .ngm-gm .gm-mx ul.mx li[data-cell="'+n.coord+'"]').addClass(e).html('<div style="background:'+$('.ngm-bk .ngm-gm .gm-mx ul.mx li[data-cell="'+n.coord+'"]').css("background")+';width:100%;height:100%;">'+(is_numeric(n.mine)?n.mine:"m"==n.mine?'<img src="tpl/img/games/bomb.png">':"")+"</div>").fadeIn(300)})}),onlineGame.extra){var a=$(".ngm-bk .msg.equal");a.fadeIn(200),window.setTimeout(function(){a.fadeOut(200)},2e3)}onlineGame.current&&(onlineGame.current!=playerId?($(".ngm-bk .ngm-gm .tm").css("text-align","right"),$(".gm-pr.r").addClass("move"),$(".gm-pr.l").removeClass("move")):($(".ngm-bk .ngm-gm .tm").css("text-align","left"),$(".gm-pr.l").addClass("move"),$(".gm-pr.r").removeClass("move"))),onlineGame.players&&$.each(onlineGame.players,function(e,a){var n=a.pid==playerId?"l":"r";$(".gm-pr."+n+" .pr-cl b").html(a.moves).hide().fadeIn(200),$(".gm-pr."+n+" .pr-pt b").html(a.points).hide().fadeIn(200)}),onlineGame.winner||updateTimeOut(onlineGame.timeout),onlineGame.winner&&($(".ngm-bk .tm").countdown("pause"),$(".ngm-bk .msg").hide(),$(".gm-pr").removeClass("move"),$(".ngm-bk .ngm-gm .gm-pr .pr-surr").hide(),class_player=onlineGame.winner==playerId?"l":"r",win=onlineGame.players[onlineGame.winner].win,setTimeout(function(){$(".msg.winner").fadeIn(200),$(".gm-pr .pr-cl").css("opacity",0),$(".gm-pr .pr-pr").hide(),$(".gm-pr."+class_player+" .pr-cl").css("opacity","100").html("<b>"+("MONEY"==onlineGame.currency?getCurrency(win,1):win)+"</b><span>"+("MONEY"==onlineGame.currency?getCurrency():"баллов")+"<br>выиграно</span>"),$(".gm-pr."+class_player).addClass("winner")},1200),$(".ngm-bk .ngm-gm .gm-mx .msg.winner .ch-ot").show(),$(".ngm-bk .ngm-gm .gm-mx .msg.winner .re").show(),$(".ngm-bk .ot-exit").hide());break;case"quit":onlineGame.quit!=playerId&&($(".ngm-bk .re").hide(),$(".ngm-bk .ot-exit").html("Соперник вышел").show()),appId=0;break;case"error":errorGame()}}function errorGame(){0==onlineGame.appId&&($(".ngm-bk .tm").countdown("pause"),appId=onlineGame.appId,$(".ngm-bk .prc-but-cover").hide(),$(".ngm-rls").fadeIn(200))}function endGame(){$(".ngm-bk .tm").countdown("pause"),$(".ngm-bk .msg").hide(),$(".gm-pr").removeClass("move"),$(".ngm-bk .ngm-gm .gm-pr .pr-surr").hide(),$(".ngm-bk .ngm-gm .gm-mx ul.mx li.w div").effect("pulsate",{times:10}),class_player=onlineGame.winner==playerId?"l":"r",win=onlineGame.players[onlineGame.winner].win,setTimeout(function(){$(".msg.winner").fadeIn(200),$(".gm-pr .pr-cl").css("opacity",0),$(".gm-pr .pr-pr").hide(),$(".gm-pr."+class_player+" .pr-cl").css("opacity","100").show().html("<b>"+("MONEY"==onlineGame.currency?getCurrency(win,1):win)+"</b><span>"+("MONEY"==onlineGame.currency?getCurrency():"баллов")+"<br>выиграно</span>"),$(".gm-pr."+class_player).addClass("winner")},3600),$(".ngm-bk .ngm-gm .gm-mx .msg.winner .ch-ot").show(),$(".ngm-bk .ngm-gm .gm-mx .msg.winner .re").show(),$(".ngm-bk .ot-exit").hide()}function runGame(){$(".ngm-bk .ngm-gm").removeClass().addClass("ngm-gm").addClass(appName),$(".ngm-rls .gm-if-bk .l").text($('.ch-gm-tbl .ngm-bt[data-game="'+appName+'"]').parent().find(".l").text()),$(".ngm-rls .rls-txt-bk").html($("#newgame-rules").find('div[data-game="'+appName+'"]').html()),$(".ngm-bk .msg").hide(),$(".ch-bk").fadeOut(200),$(".ngm-bk").fadeIn(200),$(".ngm-bk .ngm-gm .gm-mx .gm-fld").html($('#newgame-fields div[data-game="'+appName+'"]').html()),window.setTimeout(function(){$("html, body").animate({scrollTop:$(".chance").offset().top-60},500,"easeInOutQuint")},300),$(".ngm-bk .rls-r-ts").hide(),$(".ngm-rls").hide(),$(".ngm-bk .rls-r-t").show(),$(".gm-pr").removeClass("winner"),$(".ngm-bk .gm-pr.r .pr-nm").html(""),$(".ngm-bk .pr-cl").html("").hide(),$(".ngm-bk .pr-pt").html("").hide(),$(".ngm-bk .ngm-gm .gm-mx ul.mx > li").html("").removeClass()}function updateTimeOut(e,a){e&&(a=a||"{mnn}<span>:</span>{snn}",1>e?onTimeOut():($(".ngm-bk .tm:eq(0)").countdown("getTimes")&&0==$(".ngm-bk .tm:eq(0)").countdown("getTimes").reduce(function(e,a){return e+a})&&$(".ngm-bk .tm:eq(0)").countdown("destroy"),$(".ngm-bk .tm:eq(0)").countdown("getTimes")?$(".ngm-bk .tm:eq(0)").countdown("option","layout")&&$(".ngm-bk .tm:eq(0)").countdown("option","layout")==a||$(".ngm-bk .tm:eq(0)").countdown("option",{layout:a}):$(".ngm-bk .tm:eq(0)").countdown({until:e,layout:a}),$(".ngm-bk .tm:eq(0)").countdown({until:e}).countdown("resume").countdown("option",{until:e})))}function onTimeOut(){console.info("тайм-аут"),$(".ngm-bk .ngm-gm .gm-mx .mx .players .gm-pr .pr-ph-bk .circle-timer").remove();var e="app/"+appName+"/"+appId,a={action:"timeout"};WebSocketAjaxClient(e,a)}var ships=[],game_ships=[],conn;WebSocketAjaxClient(),$.cookie("audio-off")&&$(".sbk-tl-bk .b-cntrl-block").parent().find(".audio").removeClass("icon-volume-2").addClass("icon-volume-off"),$(document).on("click","#chatButton",function(){var e="chat",a={message:$("#chatMessage").val()};WebSocketAjaxClient(e,a)}),$(document).on("click",".ngm-bk .ngm-rls-bk .rls-r .now-bl .gm-now.available",function(){if(appMode=$(".gm-now-plr span",this).attr("data-mode"),appId=$(".gm-now-plr span",this).attr("data-id"),price=appMode.split("-"),"POINT"==price[0]&&playerPoints<parseInt(price[1])||"MONEY"==price[0]&&playerMoney<getCurrency(price[1],1))$("#report-popup").show().find(".txt").text(getText("INSUFFICIENT_FUNDS")).fadeIn(200);else{var e="app/"+appName+"/"+appId,a={action:"start",mode:appMode};WebSocketAjaxClient(e,a)}}),$(document).on("click",".ngm-bk .ngm-go",function(){if(appMode=$(".ngm-bk .rls-r .new-bl .prc-sel").find(".active").attr("data-price"))if(price=appMode.split("-"),appMode+="-"+($(".ngm-bk .rls-r .new-bl .plr-sel").find(".active").attr("data-players")?$(".ngm-bk .rls-r .new-bl .plr-sel").find(".active").attr("data-players"):2),"POINT"==price[0]&&playerPoints<parseInt(price[1])||"MONEY"==price[0]&&playerMoney<getCurrency(price[1],1))$("#report-popup").show().find(".txt").text(getText("INSUFFICIENT_FUNDS")).fadeIn(200);else{var e="app/"+appName+"/0",a={action:"start",mode:appMode};WebSocketAjaxClient(e,a)}else $("#report-popup").show().find(".txt").text(getText("CHOICE_BET")).fadeIn(200)}),$(document).on("click",".ngm-bk .ngm-gm .gm-mx .msg.winner .re",function(){var e="app/"+appName+"/"+appId,a={action:"replay"};WebSocketAjaxClient(e,a)}),$(document).on("click",".ngm-bk .ngm-gm .gm-mx .msg.winner .ch-ot",function(){if(appId){var e="app/"+appName+"/"+appId,a={action:"quit"};WebSocketAjaxClient(e,a),appId=0}var e="app/"+appName+"/"+appId,a={action:"start",mode:appMode};WebSocketAjaxClient(e,a)}),$(document).on("click",".ngm-bk .ngm-gm .gm-mx .msg.winner .exit",function(){if($(this).hasClass("button-disabled"))return!1;$(this).parent().find(".button").addClass("button-disabled").attr("disabled","disabled");var e="app/"+appName+"/"+appId,a={action:"quit"};WebSocketAjaxClient(e,a)}),$(document).on("click",".ngm-bk .ngm-gm .gm-mx .players .exit",function(){if($(this).hasClass("button-disabled"))return!1;$(this).addClass("button-disabled"),window.setTimeout(function(){$(this).removeClass("button-disabled")},1e3);var e="app/"+appName+"/"+appId,a={action:"quit"};WebSocketAjaxClient(e,a)}),$(document).on("click",".ngm-bk .ngm-rls-bk .rls-r .ngm-cncl",function(){appId=0;var e="app/"+appName+"/"+appId,a={action:"cancel"};WebSocketAjaxClient(e,a)}),$(document).on("click",".ngm-bk .bk-bt-rl",function(){appId=0;var e="app/"+appName+"/"+appId,a={action:"back"};WebSocketAjaxClient(e,a),WebSocketAjaxClient("update/"+appName)}),$(document).on("click",".ngm-bk .bk-bt",function(){if($(".rls-r-t").is(":visible"))$(".ngm-bk").fadeOut(200),window.setTimeout(function(){$(".ch-bk").fadeIn(200)},200);else{appId=0;var e="app/"+appName+"/"+appId,a={action:"back"};WebSocketAjaxClient(e,a)}}),$(document).on("click",".ngm-bk .cell .bt",function(){return $(this).hasClass("button-disabled")?!1:($(".ngm-bk .cell .bt").removeClass("active"),$(this).addClass("active"),$(".ngm-bk .blocks > div").hide(),void $(".ngm-bk .blocks ."+$(this).data("block")+"-bl").fadeIn(200))}),$(document).on("click",".ngm-bk .ngm-create",function(){if($(this).hasClass("button-disabled"))return!1;for($(".ngm-bk .ngm-go").addClass("button-disabled").attr("disabled","disabled"),$(".ngm-bk .ngm-rls-bk .rls-r .new-bl").find(".active").removeClass("active"),$(".ngm-bk .ngm-rls-bk .rls-r .new-bl .prc-sel").hide(),$(".ngm-bk .ngm-rls-bk .rls-r .new-bl .plr-bt, .ngm-bk .ngm-rls-bk .rls-r .new-bl .prc-bt").removeClass("hidden").show(),$(".ngm-bk .ngm-rls-bk .rls-r .new-bl .plr-sel .plr-vl, .ngm-bk .ngm-rls-bk .rls-r .new-bl .prc-sel .prc-vl").remove(),i=2;i<=onlineGame.maxPlayers;i++)$('<div class="plr-vl" data-players="'+i+'">'+i+"</div>").insertAfter($(".ngm-bk .ngm-rls-bk .rls-r .new-bl .plr-sel div").first());$(".ngm-bk .ngm-rls-bk .rls-r .new-bl .plr-sel .plr-vl").last().click(),appModes&&appModes[appName]&&$.each(appModes[appName],function(e,a){$.each(a,function(a,n){n>0&&$('<div class="prc-vl" data-price="'+e+"-"+n+'">'+("MONEY"==e?getCurrency(n,1):n)+"</div>").insertAfter($('.ngm-bk .ngm-rls-bk .rls-r .new-bl .prc-sel[data-currency="'+e+'"] div').first())})}),$(".prc-sel").each(function(){$(this).find(".prc-vl").length||("FREE"!=$(this).data("currency")||appModes&&(!appModes[appName]||!appModes[appName].POINT||$.inArray(0,appModes[appName].POINT)<0))&&$(this).prev().hide()})}),$(document).on("click",".ngm-bk .ngm-games",function(){return $(this).hasClass("button-disabled")?!1:($(".ngm-rls .rls-r .preloader").length||$(".ngm-rls .rls-r").append('<div class="preloader"></div>').find(".preloader").show(),void WebSocketAjaxClient("now/"+appName))}),$(document).on("click",".ngm-bk .ngm-rls-bk .rls-r .now-bl .filter li",function(){$(this).parent("ul").find("li").removeClass("sel"),$(this).addClass("sel"),$(".ngm-rls .rls-r .preloader").length||$(".ngm-rls .rls-r").append('<div class="preloader"></div>').find(".preloader").show(),WebSocketAjaxClient("now/"+appName)}),$(document).on("click",".ngm-bk .ngm-rating",function(){return $(this).hasClass("button-disabled")?!1:($(".ngm-rls .rls-r .preloader").length||$(".ngm-rls .rls-r").append('<div class="preloader"></div>').find(".preloader").show(),void WebSocketAjaxClient("rating/"+appName))}),$(document).on("click",".ngm-bk .ngm-rls-bk .rls-r .new-bl .prc-bt",function(){$(".ngm-bk .ngm-rls-bk .rls-r .new-bl .prc-sel .prc-vl").removeClass("active"),$(".ngm-bk .ngm-rls-bk .rls-r .new-bl .prc-sel").removeClass("active"),$(".ngm-bk .ngm-rls-bk .rls-r .new-bl .prc-sel").hide(),$(".ngm-bk .ngm-rls-bk .rls-r .new-bl .prc-bt.hidden").removeClass("hidden").show(),$(this).addClass("hidden").hide().next().show().children(':not([style$="display: none;"])').last().addClass("active"),$(".ngm-bk .ngm-go").removeClass("button-disabled").attr("disabled",!1)}),$(document).on("click",".ngm-bk .ngm-rls-bk .rls-r .new-bl .prc-sel .prc-vl",function(){$(".ngm-bk .ngm-rls-bk .rls-r .new-bl .prc-sel .prc-vl").removeClass("active"),$(this).addClass("active")}),$(document).on("click",".ngm-bk .ngm-rls-bk .rls-r .new-bl .plr-sel .plr-vl",function(){$(".ngm-bk .ngm-rls-bk .rls-r .new-bl .plr-sel .plr-vl").removeClass("active"),$(this).addClass("active")}),$(document).on("click",".ngm-gm .gm-pr.l .pr-surr",function(){surr=$(this),msg=$(".ngm-bk .ngm-gm .gm-mx .msg.ca"),surr.fadeOut(200),msg.fadeIn(200),$(".ngm-bk .ngm-gm .gm-mx .msg.ca .bt-bk .l").off("click").on("click",function(){var e="app/"+appName+"/"+appId,a={action:"pass"};WebSocketAjaxClient(e,a),msg.fadeOut(200)}),$(".ngm-bk .ngm-gm .gm-mx .msg.ca .bt-bk .r").off("click").on("click",function(){msg.fadeOut(200),surr.fadeIn(200)})}),$(document).on("click",".ngm-bk .ngm-gm .gm-mx .but.sb-random",function(){genFieldSeaBattle()}),$(document).on("click",".ngm-bk .ngm-gm .gm-mx .but.sb-ready",function(){var e="app/"+appName+"/"+appId,a={action:"field",field:window.ships};WebSocketAjaxClient(e,a)}),$(document).on("click",".chance .sbk-tl-bk .b-cntrl-block .audio",function(){$.cookie("audio-off")?($.removeCookie("audio-off"),$(this).parent().find(".audio").addClass("icon-volume-2").removeClass("icon-volume-off")):($(this).parent().find(".audio").removeClass("icon-volume-2").addClass("icon-volume-off"),$.cookie("audio-off",1,{expires:100}))}),$(document).on("click",".ngm-gm .gm-mx .players .m .btn-ready",function(){if(price=appMode.split("-"),"POINT"==price[0]&&playerPoints<parseInt(price[1])||"MONEY"==price[0]&&playerMoney<getCurrency(price[1],1))$("#report-popup").show().find(".txt").text(getText("INSUFFICIENT_FUNDS")).fadeIn(200);else{var e="app/"+appName+"/"+appId,a={action:"ready"};WebSocketAjaxClient(e,a)}}),$(document).on("click",".ngm-gm .gm-mx .players .m .btn-pass",function(){var e="app/"+appName+"/"+appId,a={action:"pass"};WebSocketAjaxClient(e,a)}),$(document).on("click",".ngm-gm .gm-mx .players .m .card:not(.select)",function(){$(".ngm-gm .gm-mx .players .m .card").removeClass("select"),$(this).addClass("select"),appDurakCallback("premove")}),$(document).on("click",".ngm-gm .gm-mx .players .m .card.select",function(){var e="app/"+appName+"/"+appId,a={action:"move",cell:$(this).attr("data-card")};WebSocketAjaxClient(e,a)}),$(document).on("click",".ngm-gm .gm-mx .table .cards.highlight",function(){var e="app/"+appName+"/"+appId,a={action:"move",cell:$(".ngm-gm .gm-mx .players .m .card.select").attr("data-card"),table:$(this).attr("data-table")};WebSocketAjaxClient(e,a)}),$(document).on("click",".ngm-gm .gm-mx ul.mx li",function(){if(parseInt($(".gm-pr.l .pr-cl b").html())<=0);else if($(".gm-pr.l").hasClass("move"))if($(this).hasClass("m")||$(this).hasClass("o")||$(this).hasClass("b"));else{$(this).addClass("b"),window.setTimeout(function(){$(this).removeClass("b")},1e3);var e="app/"+appName+"/"+appId,a={action:"move",cell:$(this).data("cell")};WebSocketAjaxClient(e,a)}else;}),$(".ch-gm-tbl .ngm-bt").click(function(){hideAllGames(),appName=$(this).data("game"),$(".ngm-bk .blocks > div").hide(),$(".ngm-bk .cell .bt.active").removeClass("active"),$(".ngm-bk .ngm-rls-bk .rls-r .rls-mn-bk .cell .bt").addClass("button-disabled").attr("disabled","disabled"),$(".ngm-rls .gm-if-bk .l").text($('.ch-gm-tbl .ngm-bt[data-game="'+appName+'"]').parent().find(".l").text()),$(".ngm-rls .rls-txt-bk").html($("#newgame-rules").find('div[data-game="'+appName+'"]').html()),$(".ngm-bk .ngm-rls-bk .rls-l .prz-fnd b").text("..."),$(".ngm-rls .rls-r .preloader").length||$(".ngm-rls .rls-r").append('<div class="preloader"></div>').find(".preloader").show(),WebSocketAjaxClient("update/"+appName),$(".ch-bk").fadeOut(200),window.setTimeout(function(){$(".ngm-bk").removeClass().addClass("ngm-bk "+appName).fadeIn(200)},200)}),$.countdown.setDefaults({alwaysExpire:!0,onExpiry:onTimeOut})});